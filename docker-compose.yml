services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - "--configFile=/etc/traefik/traefik.yaml"
    networks:
      - homelab
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
    environment:
      - TZ=${TZ}
    extra_hosts:
      - "host.docker.internal:host-gateway"

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    networks:
      - homelab
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 3 * * SUN
      - TZ=${TZ}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    network_mode: host
    restart: unless-stopped
    privileged: true
    volumes:
      - ./homeassistant:/config
      - /run/dbus:/run/dbus:ro
    environment:
      - TZ=${TZ}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - PLEX_CLAIM=${PLEX_CLAIM}
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - "${RENDER_GID}"
    volumes:
      - ./plex/config:/config
      - ./media:/data
      - ./plex/transcode:/transcode
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.homelab.local`)"
      - "traefik.http.routers.ollama.entrypoints=websecure"
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
    environment:
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:11434/api/tags" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "3000:8080"
    volumes:
      - ./open-webui:/app/backend/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chat.rule=Host(`chat.homelab.local`)"
      - "traefik.http.routers.chat.entrypoints=websecure"
      - "traefik.http.routers.chat.tls=true"
      - "traefik.http.services.chat.loadbalancer.server.port=8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "5678:5678"
    volumes:
      - ./n8n:/home/node/.n8n
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.homelab.local`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASS}
      - N8N_SECURE_COOKIE=false
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5678/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  samba:
    image: dperson/samba:latest
    container_name: samba
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "137-139:137-139/udp"
      - "445:445"
    environment:
      - USERID=${PUID}
      - GROUPID=${PGID}
      - TZ=${TZ}
      - USER=${SAMBA_USER};${SAMBA_PASS}
    volumes:
      - ./media:/mount/media:rw
    command: "-u \"${SAMBA_USER};${SAMBA_PASS}\" -s \"Media;/mount/media;yes;no;no;${SAMBA_USER}\""
    healthcheck:
      test: [ "CMD", "bash", "-c", "</dev/tcp/localhost/445" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Google Antigravity Code Editor (VNC-based IDE)
  antigravity:
    image: ghcr.io/rawritude/antigravity-remote:latest
    container_name: antigravity
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "6080:6080"
      - "5900:5900"
    volumes:
      - ./antigravity/workspace:/home/devuser/workspace
      - ./antigravity/config:/home/devuser/.config
    environment:
      - VNC_PASSWORD=${ANTIGRAVITY_VNC_PASSWORD}
      - OLLAMA_HOST=http://ollama:11434
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6080" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.antigravity.rule=Host(`antigravity.homelab.local`)"
      - "traefik.http.routers.antigravity.entrypoints=websecure"
      - "traefik.http.routers.antigravity.tls=true"
      - "traefik.http.services.antigravity.loadbalancer.server.port=6080"
    depends_on:
      - ollama
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # OpenClaw AI Agent
  openclaw:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw
    restart: unless-stopped
    networks:
      - homelab
    ports:
      - "3005:3000"
    volumes:
      - ./openclaw:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - OLLAMA_API_BASE=http://ollama:11434
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_TOKEN}
      - TZ=${TZ}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw.rule=Host(`openclaw.homelab.local`)"
      - "traefik.http.routers.openclaw.entrypoints=websecure"
      - "traefik.http.routers.openclaw.tls=true"
      - "traefik.http.services.openclaw.loadbalancer.server.port=3000"
    depends_on:
      - ollama
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  ollama_models:


networks:
  homelab:
    driver: bridge
